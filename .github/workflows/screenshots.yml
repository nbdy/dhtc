name: Screenshots

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  screenshots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          check-latest: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps

      - name: Build CSS
        run: npm run build:css

      - name: Build Go App
        run: go build -v -o dhtc cmd/dhtc/main.go

      - name: Create screenshots directory
        run: mkdir -p screenshots

      - name: Run Go App in background
        run: ./dhtc --OnlyWebServer --address :4200 &

      - name: Capture Screenshots
        run: node scripts/screenshot.js

      - name: Commit and Push Screenshots
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add screenshots/*.png
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update screenshots" && git push)
